<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Редактирование заявки</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f8f9fa;
            padding: 30px 15px;
        }

        .btn-black {
            background-color: #000;
            color: #fff;
            border: none;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn-black:hover, .btn-black:focus {
            background-color: #222;
            color: #fff;
        }

        img {
            max-height: 50px;
            object-fit: contain;
            border-radius: 4px;
        }

        table th, table td {
            vertical-align: middle !important;
        }

        h2 {
            margin-top: 2.5rem;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            max-width: 400px;
        }

        /* Чтобы кнопки в таблицах не растягивались */
        .btn-sm {
            padding: 0.25rem 0.6rem;
            font-size: 0.85rem;
        }
    </style>
    <script th:inline="javascript">
        let cart = [];

        function renderCart() {
            const cartTable = document.getElementById("cartTableBody");
            cartTable.innerHTML = "";

            cart.forEach((item, index) => {
                cartTable.innerHTML += `
                    <tr>
                        <td><img src="${item.photo}" alt="Фото" /></td>
                        <td>${item.name}</td>
                        <td>${item.price.toFixed(2)}</td>
                        <td>${item.type}</td>
                        <td>${item.size}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-black" onclick="removeFromCart(${index})">
                                Удалить
                            </button>
                        </td>
                    </tr>`;
            });

            document.getElementById("cartJson").value = JSON.stringify(
                cart.reduce((acc, item) => {
                    const existing = acc.find(i => i.id === item.id);
                    if (existing) {
                        existing.count++;
                    } else {
                        acc.push({ id: item.id, count: 1 });
                    }
                    return acc;
                }, [])
            );
        }

        function addToCart(btn) {
            const item = {
                id: parseInt(btn.getAttribute("data-id")),
                name: btn.getAttribute("data-name"),
                price: parseFloat(btn.getAttribute("data-price")),
                photo: btn.getAttribute("data-photo"),
                type: btn.getAttribute("data-type"),
                size: btn.getAttribute("data-size")
            };

            cart.push(item);
            renderCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function submitForm() {
            renderCart();
            return true;
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".addToCartBtn").forEach(btn => {
                btn.addEventListener("click", () => addToCart(btn));
            });

            // Инициализация из Thymeleaf
            const initialCart = /*[[${orderDetailsJson}]]*/ '[]';
            try {
                const parsed = JSON.parse(initialCart);
                parsed.forEach(orderDetail => {
                    cart.push({
                        id: orderDetail.item.id,
                        name: orderDetail.item.name,
                        price: orderDetail.item.value,
                        photo: orderDetail.item.photo,
                        type: orderDetail.item.type.type,
                        size: orderDetail.item.size.size
                    });
                });
            } catch (e) { console.error("Failed to load initial cart", e); }

            renderCart();
        });
    </script>
</head>
<body>

<div class="container">
    <form id="editForm" th:action="@{'/application/edit/' + ${application.id}}" method="post" onsubmit="return submitForm()" class="needs-validation" novalidate>
        <div class="mb-3">
            <label for="fioInput" class="form-label">ФИО</label>
            <input type="text" class="form-control" id="fioInput" name="FIO" th:value="${application.FIO}" required />
            <div class="invalid-feedback">Пожалуйста, заполните ФИО.</div>
        </div>

        <div class="mb-3">
            <label for="phoneInput" class="form-label">Телефон</label>
            <input type="text" class="form-control" id="phoneInput" name="phoneNumber" th:value="${application.phoneNumber}" required />
            <div class="invalid-feedback">Пожалуйста, введите телефон.</div>
        </div>

        <div class="mb-3">
            <label for="telegramInput" class="form-label">Telegram</label>
            <input type="text" class="form-control" id="telegramInput" name="telegram" th:value="${application.telegram}" />
        </div>

        <input type="hidden" name="cartJson" id="cartJson" />

        <a href="/application/show" class="btn btn-link mb-4">&larr; Назад</a>

        <h2>Корзина</h2>
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                <tr>
                    <th>Фото</th>
                    <th>Название</th>
                    <th>Цена</th>
                    <th>Тип</th>
                    <th>Размер</th>
                    <th>Удалить</th>
                </tr>
                </thead>
                <tbody id="cartTableBody"></tbody>
            </table>
        </div>

        <h2>Список товаров</h2>
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                <tr>
                    <th>Фото</th>
                    <th>Название</th>
                    <th>Цена</th>
                    <th>Тип</th>
                    <th>Размер</th>
                    <th>Добавить</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${items}">
                    <td><img th:src="@{${item.photo}}" alt="Фото" /></td>
                    <td th:text="${item.name}"></td>
                    <td th:text="${item.value}"></td>
                    <td th:text="${item.type.type}"></td>
                    <td th:text="${item.size.size}"></td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-black addToCartBtn"
                                th:attr="
                                        data-id='${item.id}',
                                        data-name='${item.name}',
                                        data-price='${item.value}',
                                        data-photo='${item.photo}',
                                        data-type='${item.type.type}',
                                        data-size='${item.size.size}'">
                            В корзину
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <button type="submit" class="btn btn-black btn-lg mt-4">Сохранить изменения</button>
    </form>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Bootstrap form validation
    (() => {
        'use strict'

        const forms = document.querySelectorAll('.needs-validation')

        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }

                form.classList.add('was-validated')
            }, false)
        })
    })()
</script>

</body>
</html>
